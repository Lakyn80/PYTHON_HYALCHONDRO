{% extends "layout_admin.html" %} {% block title %}Objedn√°vky{% endblock %} {%
block content %}

<h2 class="text-center mb-4">üìã Objedn√°vky z√°kazn√≠k≈Ø</h2>

<!-- DataTables CSS -->
<link
  rel="stylesheet"
  href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='admin/css/orders_table.css') }}"
/>

<!-- Export tlaƒç√≠tka -->
<div class="d-flex gap-2 mb-3">
  <form
    method="POST"
    action="{{ url_for('admin.export_orders_route', format='excel') }}"
  >
    <button type="submit" class="btn btn-success btn-sm">
      ‚¨áÔ∏è Export Excel
    </button>
  </form>
  <form
    method="POST"
    action="{{ url_for('admin.export_orders_route', format='csv') }}"
  >
    <button type="submit" class="btn btn-secondary btn-sm">
      ‚¨áÔ∏è Export CSV
    </button>
  </form>
  <form
    method="POST"
    action="{{ url_for('admin.export_orders_route', format='pdf') }}"
  >
    <button type="submit" class="btn btn-danger btn-sm">‚¨áÔ∏è Export PDF</button>
  </form>
</div>

<div class="orders-wrapper">
  <table
    id="orders-table"
    class="display nowrap admin-table"
    style="width: 100%"
  >
    <thead>
      <tr>
        <th>Faktura</th>
        <th>Objedn√°vka</th>
        <th>Jm√©no</th>
        <th>Email</th>
        <th>Adresa</th>
        <th>Produkt</th>
        <th>Mno≈æstv√≠</th>
        <th>Datum</th>
        <th>Stav</th>
        <th>üóëÔ∏è</th>
      </tr>
    </thead>
    <tbody>
      {% for order in orders %}
      <tr>
        <td>F{{ "%03d"|format(order.id) }}</td>
        <td>ORD{{ "%03d"|format(order.id) }}</td>
        <td>{{ order.name }}</td>
        <td>{{ order.email }}</td>
        <td>{{ order.address }}</td>
        <td>{{ order.product.name }}</td>
        <td>{{ order.quantity }}</td>
        <td>{{ order.created_at.strftime('%d.%m.%Y') }}</td>
        <td>
          <div
            class="custom-status-dropdown status-{{ order.status.lower().replace(' ', '-') }}"
            data-order-id="{{ order.id }}"
          >
            <span class="current-status">{{ order.status }}</span>
            <ul class="status-options">
              {% for status_option in ['Nov√°', 'Zpracov√°v√° se', 'Odesl√°no',
              'Zru≈°eno'] %}
              <li data-value="{{ status_option }}">{{ status_option }}</li>
              {% endfor %}
            </ul>
          </div>
        </td>
        <td>
          <button
            type="button"
            class="btn btn-outline-danger btn-sm delete-order-btn"
          >
            üóëÔ∏è
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- JS knihovny -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
  $(document).ready(function () {
    $("#orders-table").DataTable({
      responsive: true,
      language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/cs.json" },
    });

    // Dropdown ‚Äì zmƒõna stavu
    $(".custom-status-dropdown").on("click", function (e) {
      e.stopPropagation();
      $(".status-options").not($(this).find(".status-options")).hide();
      $(this).find(".status-options").toggle();
    });

    $(document).on("click", function () {
      $(".status-options").hide();
    });

    $(".status-options li").on("click", function (e) {
      e.stopPropagation();
      const newStatus = $(this).data("value");
      const dropdown = $(this).closest(".custom-status-dropdown");
      const orderId = dropdown.data("order-id");

      dropdown.find(".current-status").text(newStatus);
      dropdown.removeClass(
        "status-nova status-zpracovava-se status-odeslano status-zruseno"
      );
      dropdown.addClass(
        "status-" + newStatus.toLowerCase().replace(/\s+/g, "-")
      );
      dropdown.find(".status-options").hide();

      $.ajax({
        url: "/admin/api/update-order-status",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ order_id: orderId, status: newStatus }),
        success: function (res) {
          console.log("‚úÖ " + res.message);
        },
        error: function () {
          alert("‚ùå Chyba p≈ôi zmƒõnƒõ stavu");
        },
      });
    });

    // Inicializace barev
    $(".custom-status-dropdown").each(function () {
      const currentText = $(this)
        .find(".current-status")
        .text()
        .toLowerCase()
        .replace(/\s+/g, "-");
      $(this).addClass("status-" + currentText);
    });

    // üóëÔ∏è Soft delete
    $(".delete-order-btn").on("click", function () {
      const row = $(this).closest("tr");
      const orderId = row.find(".custom-status-dropdown").data("order-id");

      $.ajax({
        url: "/admin/api/hide-order",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ order_id: orderId }),
        success: function (res) {
          if (res.success) {
            row.remove();
          }
        },
        error: function () {
          alert("‚ùå Chyba p≈ôi maz√°n√≠ objedn√°vky.");
        },
      });
    });
  });
</script>

{% endblock %}
